---
title: "GSE255690_ovary young VS old_Secreted Signaling_20240823补充"
author: "Deng Xin yin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: united
    df_print: kable
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
mainfont: Arial
vignette: "%\\VignetteIndexEntry{GSE255690-human ovary} %\\VignetteEngine{knitr::rmarkdown}
  %\\VignetteEncoding{UTF-8}\n"
---

```{r setup, include=FALSE}
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now, units = "secs")
      all_times[[options$label]] <<- res
    }
  }
}))
knitr::opts_chunk$set(
  tidy = TRUE,  # 美化代码输出
  tidy.opts = list(width.cutoff = 95),  # 设定代码美化的宽度限制
  message = FALSE,  # 不显示信息
  warning = FALSE,  # 不显示警告
  time_it = TRUE,  # 启用执行时间测量
  error = TRUE,  # 保留错误信息
  fig.height = 8,  # 设置图像高度
  fig.width = 8,  # 设置图像宽度
  fig.align = 'center'  # 设置图像对齐方式为居中
)

```

```{r,echo=FALSE}
setwd('/home/hsinyinteng/GSE255690_human_ovary/')
library(patchwork)
library(Seurat)
library(tidyverse)
library(data.table)
library(harmony)
library(CellChat)
library(umap)
library(pryr)  
options(stringsAsFactors = F)
future::plan("multisession", workers = 6) # 设置多线程计算
options(future.globals.maxSize = 3 * 1024^3)

ovary_young <- readRDS("GSE255690_ovary_young_cellchat_Secreted Signaling_240608_OK.rds")   
ovary_old <- readRDS("GSE255690_ovary_old_cellchat_Secreted Signaling_240608_OK.rds")   
ovary_young <- updateCellChat(ovary_young)
ovary_old <- updateCellChat(ovary_old)
object.list <- list(young = ovary_young, old = ovary_old)
cellchat <- mergeCellChat(object.list, add.names = names(object.list))
# cellchat <- readRDS("GSE255690_ovary_young_vs_ovary_old_cellchat_Secreted Signaling_240610.rds")

# 将所有因子向量合并为一个
combined_idents <- c(cellchat@idents$young, cellchat@idents$old, cellchat@idents$joint)
# 计算各细胞类型的总数
cell_counts <- table(combined_idents)
# 计算每个细胞群体的比例
cell_proportions <- cell_counts / sum(cell_counts)


```


# ovary young VS old @整体通路变化 @Hierarchy图 
```{r,echo=TRUE,fig.width=12,fig.height=8,fig.align='center'}
young_pathway <- cellchat@netP[["young"]][["pathways"]]
old_pathway <- cellchat@netP[["old"]][["pathways"]]

common_pathways <- intersect(young_pathway, old_pathway)  # 取交集
all_pathways <- union(young_pathway, old_pathway)  # 取并集
unique_young_pathways <- setdiff(young_pathway, old_pathway)  # 查看 young_pathway 中特有的通路
# "AMH"  "WNT"  "IL10" "PRL"  "EPO" 
unique_old_pathways <- setdiff(old_pathway, young_pathway)  # 查看 old_pathway 中特有的通路
# "CX3C"  "MHC-I" "GDF"   "FSH"

library(VennDiagram)
# 画维恩图
venn.plot <- venn.diagram(
  x = list(Young = young_pathway, Old = old_pathway),
  filename = NULL, # 如果不想保存为文件，可以设置为 NULL
  fill = c("#00FF00","#FF0000"),
  alpha = 0.5,
  cex = 2,
  cat.cex = 2,
  cat.pos = c(-20, 20),
  cat.dist = 0.03,
  cat.just = list(c(1, 1), c(0, 0))
)

# 显示维恩图
grid.draw(venn.plot)



pathways.show <- common_pathways # young和old的共有通路

par(mfrow = c(1,2), xpd=TRUE)
for (pathway in pathways.show) {
  for (i in 1:length(object.list)) {
      weight.max <- getMaxWeight(object.list,  
                           slot.name = c("netP"), 
                           attribute = pathway) 
      
        netVisual_aggregate(
          object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
          signaling = pathway,             # 逐一传递单个通路名称
          sources.use = NULL,              # 指定源细胞群体的索引
          targets.use = NULL,              # 指定目标细胞群体的索引
          layout = "hierarchy",            # 图的布局类型，这里选择层次布局
          vertex.receiver = seq(1,3), 
          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
          pt.title = 15,                   # 设置标题文本的字体大小
          title.space = 4,                 # 设置标题与图之间的空间
          vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
          sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
          alpha.image = 0.15,              # 设置单个点的透明度
          point.size = 1.5,                # 设置点的大小
          edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
          edge.width.max = 10,             # 设置可视化的最大边宽度
          signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary') # 设置信号通路名称
        )
    }
}


```


# Oocyte
## Oocyte主要通路变化(非全部)
```{r,echo=TRUE,fig.width=12,fig.height=8,fig.align='center'}
pathways.show <- c('COMPLEMENT','FLT3','BAFF','NGF','NPR2','FASLG','CSF','LIGHT','CD40','TRAIL','LT','TNF','FGF','PROS','BMP','CALCR','IL6','IGF','EGF','LIFR','IGFBP','PDGF','GAS','TGFb','VEGF','VISFATIN','PTN','CypA','CCL','MIF','MK')  # 根据信号变化，手动筛选的

par(mfrow = c(1,2), xpd=TRUE)
for (pathway in pathways.show) {
  for (i in 1:length(object.list)) {
      weight.max <- getMaxWeight(object.list, 
                           slot.name = c("netP"), 
                           attribute = pathway) 
      
        netVisual_aggregate(
          object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
          signaling = pathway,             # 逐一传递单个通路名称
          sources.use = NULL,              # 指定源细胞群体的索引
          targets.use = NULL,              # 指定目标细胞群体的索引
          layout = "hierarchy",            # 图的布局类型，这里选择层次布局
          vertex.receiver = seq(3,1), 
          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
          pt.title = 15,                   # 设置标题文本的字体大小
          title.space = 4,                 # 设置标题与图之间的空间
          vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
          sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
          alpha.image = 0.15,              # 设置单个点的透明度
          point.size = 1.5,                # 设置点的大小
          edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
          edge.width.max = 10,             # 设置可视化的最大边宽度
          signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary') # 设置信号通路名称
        )
    }
}


```

## Oocyte通路变化 @netVisual_diffInteraction
```{r,echo=TRUE,fig.width=12,fig.height=12,fig.align='center'}
par(mfrow = c(2,2), xpd=TRUE)
oo1 <- netVisual_diffInteraction(cellchat,                   # CellChat对象
                                measure = "count",           # 比较度量标准，"count"表示交互次数
                          weight.scale = TRUE,         # 是否缩放权重以匹配其他变量的尺度
                          comparison = c(1, 2),        # 指定要比较的两个数据集
                          sources.use = 6,          # 源细胞群体，默认为NULL表示使用所有源细胞群体
                          targets.use = NULL,          # 目标细胞群体，索引6表示Oocyte
                          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
                          edge.width.max = 10,          # 边的最大宽度，用于可视化
                          alpha.edge = 0.6,            # 边的透明度
                          arrow.width = 1,             # 箭头的宽度
                          arrow.size = 2,              # 箭头的大小
                          title.name = 'Signal counts between young and old ovary(from oocyte)', # 图表标题
                          color.edge = c("#00FF00","#FF0000"), # 用于指示信号增加（'color.edge[1]'）或减少（'color.edge[2]'）的颜色
                          label.edge = TRUE,           # 是否显示边的标签
                          edge.label.color = "black",  # 边标签的颜色
                          edge.label.cex = 0.8)        # 边标签的大小

oo2 <- netVisual_diffInteraction(cellchat,                   # CellChat对象
                                 measure = "weight",          # 比较度量标准，"weight"表示交互权重（强度）
                          weight.scale = TRUE,         # 是否缩放权重以匹配其他变量的尺度
                          comparison = c(1, 2),        # 指定要比较的两个数据集
                          sources.use = 6,          # 源细胞群体，默认为NULL表示使用所有源细胞群体
                          targets.use = NULL,          # 目标细胞群体，索引6表示Oocyte
                          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
                          edge.width.max = 10,          # 边的最大宽度，用于可视化
                          alpha.edge = 0.6,            # 边的透明度
                          arrow.width = 1,             # 箭头的宽度
                          arrow.size = 2,              # 箭头的大小
                          title.name = 'Signal weights between young and old ovary(from oocyte)', # 图表标题
                          color.edge = c("#00FF00","#FF0000"), # 用于指示信号增加（'color.edge[1]'）或减少（'color.edge[2]'）颜色
                          label.edge = TRUE,           # 是否显示边的标签
                          edge.label.color = "black",  # 边标签的颜色
                          edge.label.cex = 0.8 )        # 边标签的大小

oo3 <- netVisual_diffInteraction(cellchat,                   # CellChat对象
                                measure = "count",           # 比较度量标准，"count"表示交互次数
                          weight.scale = TRUE,         # 是否缩放权重以匹配其他变量的尺度
                          comparison = c(1, 2),        # 指定要比较的两个数据集
                          sources.use = NULL,          # 源细胞群体，默认为NULL表示使用所有源细胞群体
                          targets.use = 6,          # 目标细胞群体，索引6表示Oocyte
                          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
                          edge.width.max = 10,          # 边的最大宽度，用于可视化
                          alpha.edge = 0.6,            # 边的透明度
                          arrow.width = 1,             # 箭头的宽度
                          arrow.size = 2,              # 箭头的大小
                          title.name = 'Signal counts between young and old ovary(to oocyte)', # 图表标题
                          color.edge = c("#00FF00","#FF0000"), # 用于指示信号增加（'color.edge[1]'）或减少（'color.edge[2]'）的颜色
                          label.edge = TRUE,           # 是否显示边的标签
                          edge.label.color = "black",  # 边标签的颜色
                          edge.label.cex = 0.8)        # 边标签的大小

oo4 <- netVisual_diffInteraction(cellchat,                   # CellChat对象
                                 measure = "weight",          # 比较度量标准，"weight"表示交互权重（强度）
                          weight.scale = TRUE,         # 是否缩放权重以匹配其他变量的尺度
                          comparison = c(1, 2),        # 指定要比较的两个数据集
                          sources.use = NULL,          # 源细胞群体，默认为NULL表示使用所有源细胞群体
                          targets.use = 6,          # 目标细胞群体，索引6表示Oocyte
                          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
                          edge.width.max = 10,          # 边的最大宽度，用于可视化
                          alpha.edge = 0.6,            # 边的透明度
                          arrow.width = 1,             # 箭头的宽度
                          arrow.size = 2,              # 箭头的大小
                          title.name = 'Signal weights between young and old ovary(to oocyte)', # 图表标题
                          color.edge = c("#00FF00","#FF0000"), # 用于指示信号增加（'color.edge[1]'）或减少（'color.edge[2]'）颜色
                          label.edge = TRUE,           # 是否显示边的标签
                          edge.label.color = "black",  # 边标签的颜色
                          edge.label.cex = 0.8 )        # 边标签的大小
oo1+oo2+oo3+oo4


# 绿色和红色分别代表了信号交互的增加和减少。具体含义如下：
# 绿色（#00FF00）：表示信号交互的增加。这意味着在年轻组与年老组的比较中，某些细胞群体间的信号交互在年轻组中更多。
# 红色（#FF0000）：表示信号交互的减少。这意味着在年轻组与年老组的比较中，某些细胞群体间的信号交互在年老组中更多。
# 因此，当你在图表中看到绿色的边时，这些边表示年轻组中的信号交互次数比年老组更多；而红色的边表示年老组中的信号交互次数比年轻组更多。
```

## Oocyte通路变化 @rankNet
```{r,echo=TRUE,fig.width=12,fig.height=14,fig.align='center'}
par(mfrow = c(2,2), xpd=TRUE)
oo5 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("count"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = NULL,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling count from other cells to Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo6 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("weight"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = NULL,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling weight from other cells to Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo7 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("count"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = NULL,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling count from Oocyte to other cells",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo8 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("weight"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = NULL,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling weight from Oocyte to other cells",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo5+oo6+oo7+oo8

```

## Oocyte通路变化 @netAnalysis_signalingChanges_scatter @hierarchy图
```{r,echo=TRUE,fig.width=12,fig.height=8,fig.align='center'}
netAnalysis_signalingChanges_scatter(
  cellchat,                          # 合并的 CellChat 对象或 CellChat 对象列表
  idents.use = "Oocyte",             # 感兴趣的细胞群体名称为 "Oocyte"
  color.use = c("#000000","#00FF00", "#FF0000"),  # 着色方案
  comparison = c(1, 2),              # 比较数据集 1 和 2
  signaling = NULL,                  # 默认分析所有信号通路
  signaling.label = NULL,            # 不指定标注的信号通路
  top.label = 1,                     # 标注的信号通路比例
  signaling.exclude = NULL,          # 不排除任何信号通路
  xlims = NULL,                      # 不指定 x 轴限制
  ylims = NULL,                      # 不指定 y 轴限制
  slot.name = "netP",                # 槽名称，用于计算信号网络的中心性度量
  dot.size = 3,                      # 符号的大小
  #point.shape = c(21, 22, 24, 23),   # 点的形状
  label.size = 5,                    # 文本标签的大小
  dot.alpha = 0.6,                   # 符号的透明度
  x.measure = "outdeg",              # 用作 x 轴的度量标准，为外向交互强度
  y.measure = "indeg",               # 用作 y 轴的度量标准，为内向交互强度
  # xlabel = "Differential outgoing interaction strength",  # x 轴标签
  # ylabel = "Differential incoming interaction strength",  # y 轴标签
  # title = NULL,                      # 图的主标题
  font.size = 15,                    # 文本字体大小
  font.size.title = 15,              # 标题字体大小
  do.label = TRUE,                   # 是否对每个点进行标注
  show.legend = TRUE,                # 是否显示图例
  show.axes = TRUE                   # 是否显示坐标轴
)


gg2 <- netAnalysis_signalingChanges_scatter(
  cellchat,                          # 合并的 CellChat 对象或 CellChat 对象列表
  idents.use = "Oocyte",             # 感兴趣的细胞群体名称为 "Oocyte"
  color.use = c("#000000","#00FF00", "#FF0000"),  # 着色方案
  comparison = c(1, 2),              # 比较数据集 1 和 2
  signaling = NULL                  # 默认分析所有信号通路
)

# Oocyte
data_label <- gg2[["plot_env"]][["data.label"]]
data_label[data_label$specificity == "young specific", "labels"]
# "NT"      "ACTIVIN" "WNT"     "CSF"     "PLAU"    "IL10"
data_label[data_label$specificity == "Shared", "labels"]
# "MK"       "MIF"      "CCL"      "CypA"     "VEGF"     "CXCL"     "TGFb"     "ANGPT"    "ANGPTL"   "IGFBP"   
# "GALECTIN" "EGF"      "IGF"      "BMP"      "IL2"      "TNF"      "PARs"     "IL4"      "GRN"      "NRG"     
# "IFN-II"   "MSTN"     "PSAP"     "LIGHT"    "BTLA"     "GH"       "NPR2" 
data_label[data_label$specificity == "old specific", "labels"]
# "PTN"        "VISFATIN"   "GAS"        "PDGF"       "LIFR"       "OSM"        "IL6"        "CALCR"     
# "PROS"       "FGF"        "LT"         "TRAIL"      "IL1"        "CD40"       "HGF"        "KIT"       
# "FASLG"      "NGF"        "BAFF"       "FLT3"       "CSF3"       "COMPLEMENT" "GDF"        "FSH"

# data_label$labels



# "WNT","IL10","HGF","KIT","GH","FASLG","GDF","FSH" 
pathways.show <- c( "MK","MIF","CCL","CypA","PTN","VISFATIN","VEGF",
"CXCL","TGFb","ANGPT","GAS","PDGF","ANGPTL","IGFBP",
"GALECTIN","LIFR","EGF","IGF","OSM","IL6","CALCR",
"BMP","PROS","NT","IL2","FGF","TNF","LT", 
"TRAIL","ACTIVIN","IL1","PARs","IL4","GRN",             
"NRG","IFN-II","MSTN","PSAP","CD40","LIGHT","CSF",
"PLAU","BTLA",                    
"NPR2","NGF","BAFF","FLT3","CSF3","COMPLEMENT"  ) 


par(mfrow = c(1,2), xpd=TRUE)
for (pathway in pathways.show) {
  for (i in 1:length(object.list)) {
      weight.max <- getMaxWeight(object.list, 
                           slot.name = c("netP"), 
                           attribute = pathway) 
      
        netVisual_aggregate(
          object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
          signaling = pathway,             # 逐一传递单个通路名称
          sources.use = NULL,              # 指定源细胞群体的索引
          targets.use = NULL,              # 指定目标细胞群体的索引
          layout = "hierarchy",            # 图的布局类型，这里选择层次布局
          vertex.receiver = seq(3,1), 
          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
          pt.title = 15,                   # 设置标题文本的字体大小
          title.space = 3,                 # 设置标题与图之间的空间
          vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
          sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
          alpha.image = 0.15,              # 设置单个点的透明度
          point.size = 1.5,                # 设置点的大小
          edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
          edge.width.max = 10,             # 设置可视化的最大边宽度
          signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary') # 设置信号通路名称
        )
    }
}


```

## Oocyte接收的信号(targets.use = Oocyte)
```{r,echo=TRUE,fig.width=12,fig.height=12,fig.align='center'}
# 在衰老过程中发生明显变化的通路
pathways.show <- c("NT","ACTIVIN","CSF","PLAU",
                   
"MK","MIF","CCL","CypA","VEGF","CXCL","TGFb","ANGPT","ANGPTL","IGFBP",   
"GALECTIN","EGF","IGF","BMP","IL2","TNF","PARs","IL4","GRN","NRG",     
"IFN-II","MSTN","PSAP","LIGHT","BTLA","GH","NPR2",

"PTN","VISFATIN","GAS","PDGF","LIFR","OSM","IL6","CALCR",    
"PROS","FGF","LT","TRAIL","IL1","CD40","HGF","KIT",       
"FASLG","NGF","BAFF","FLT3","CSF3","COMPLEMENT")

                 
# 设置图像布局,每个通路有2张图（年轻和年老）
par(mfrow = c(4,4), xpd=TRUE)
# 遍历每个通路
for (pathway in pathways.show) {
  
  # 遍历年轻和年老组
  for (i in 1:length(object.list)) {
    # 使用 tryCatch 来捕获并忽略错误
    tryCatch({
      # 绘制网络图
      weight.max <- getMaxWeight(object.list, 
                               slot.name = c("netP"), 
                               attribute = pathway) # 控制不同数据集间的边权重
      
      netVisual_aggregate(
        object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
        signaling = pathway,             # 当前循环中的通路名称
        sources.use = NULL,              # 指定源细胞群体的索引；默认为 NULL，表示使用所有源
        targets.use = 6,              # 指定目标细胞群体的索引；默认为 NULL，表示使用所有目标
        layout = "circle",               # 图的布局类型，这里选择圆形布局
        edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
        edge.width.max = 10,             # 设置可视化的最大边宽度，增大最大边宽度以调整箭头大小
        pt.title = 14,                   # 设置标题文本的字体大小
        title.space = 4,                 # 设置标题与图之间的空间
        vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
        vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
        sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
        alpha.image = 0.15,              # 设置单个点的透明度
        point.size = 2,                  # 设置点的大小
        signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary')   # 修改标题
        )
    }, error = function(e) {
      message(paste("Error in pathway", pathway, "for", names(object.list)[i], ": ", e$message))
      # 错误处理：可以在此处记录日志或简单地忽略错误
    })
  }

}


```

## Oocyte发出的信号(sources.use = Oocyte) 
```{r,echo=TRUE,fig.width=12,fig.height=12,fig.align='center'}
# 在衰老过程中发生明显变化的通路
# 设置显示的通路
pathways.show <- c("NT","ACTIVIN","CSF","PLAU",
"MK","MIF","CCL","CypA","VEGF","CXCL","TGFb","ANGPT","ANGPTL","IGFBP",   
"GALECTIN","EGF","IGF","BMP","IL2","TNF","PARs","IL4","GRN","NRG",     
"IFN-II","MSTN","PSAP","LIGHT","BTLA","GH","NPR2",

"PTN","VISFATIN","GAS","PDGF","LIFR","OSM","IL6","CALCR",    
"PROS","FGF","LT","TRAIL","IL1","CD40","HGF","KIT",       
"FASLG","NGF","BAFF","FLT3","CSF3","COMPLEMENT")

                 
# 设置图像布局,每个通路有2张图（年轻和年老）
par(mfrow = c(4,4), xpd=TRUE)
# 遍历每个通路
for (pathway in pathways.show) {
  
  # 遍历年轻和年老组
  for (i in 1:length(object.list)) {
    # 使用 tryCatch 来捕获并忽略错误
    tryCatch({
      # 绘制网络图
      weight.max <- getMaxWeight(object.list, 
                               slot.name = c("netP"), 
                               attribute = pathway) # 控制不同数据集间的边权重
      
      netVisual_aggregate(
        object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
        signaling = pathway,             # 当前循环中的通路名称
        sources.use = 6,              # 指定源细胞群体的索引；默认为 NULL，表示使用所有源
        targets.use = NULL,              # 指定目标细胞群体的索引；默认为 NULL，表示使用所有目标
        layout = "circle",               # 图的布局类型，这里选择圆形布局
        edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
        edge.width.max = 10,             # 设置可视化的最大边宽度，增大最大边宽度以调整箭头大小
        pt.title = 14,                   # 设置标题文本的字体大小
        title.space = 4,                 # 设置标题与图之间的空间
        vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
        vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
        sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
        alpha.image = 0.15,              # 设置单个点的透明度
        point.size = 2,                  # 设置点的大小
        signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary')   # 修改标题
        )
    }, error = function(e) {
      message(paste("Error in pathway", pathway, "for", names(object.list)[i], ": ", e$message))
      # 错误处理：可以在此处记录日志或简单地忽略错误
    })
  }

}


```


## Oocyte的自分泌信号数量及强度 @rankNet
```{r,echo=TRUE}
oo11 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("count"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Autocrine signaling count of Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo12 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("weight"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Autocrine signaling weight of Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo11+oo12

# 可知，Oocyte的自分泌信号为：
# Young:   'NPR2','CSF','PARs','ACTIVIN','NT','IGF','CCL','MIF',

# Old:     'EGF','CSF3','FLT3','NGF','TRAIL','FGF','IL2','CALCR','GAS','TGFb','VISFATIN'
```

## Oocyte自分泌信号验证 @circle图
```{r,echo=TRUE,fig.width=9,fig.height=9,fig.align='center'}
# 在衰老过程中发生明显变化的通路
# 设置显示的通路
pathways.show <- c('NPR2','CSF','PARs','ACTIVIN','NT','IGF','CCL','MIF',
                   'EGF','CSF3','FLT3','NGF','TRAIL','FGF','IL2','CALCR','GAS','TGFb','VISFATIN')

# 设置图像布局,每个通路有2张图（年轻和年老）
par(mfrow = c(2,2), xpd=TRUE)
# 遍历每个通路
for (pathway in pathways.show) {
  
  # 遍历年轻和年老组
  for (i in 1:length(object.list)) {
    # 使用 tryCatch 来捕获并忽略错误
    tryCatch({
      # 绘制网络图
      weight.max <- getMaxWeight(object.list, 
                               slot.name = c("netP"), 
                               attribute = pathway) # 控制不同数据集间的边权重
      
      netVisual_aggregate(
        object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
        signaling = pathway,             # 当前循环中的通路名称
        sources.use = 6,              # 指定源细胞群体的索引；默认为 NULL，表示使用所有源
        targets.use = 6,              # 指定目标细胞群体的索引；默认为 NULL，表示使用所有目标
        layout = "circle",               # 图的布局类型，这里选择圆形布局
        edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
        edge.width.max = 10,             # 设置可视化的最大边宽度，增大最大边宽度以调整箭头大小
        pt.title = 14,                   # 设置标题文本的字体大小
        title.space = 4,                 # 设置标题与图之间的空间
        vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
        vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
        sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
        alpha.image = 0.15,              # 设置单个点的透明度
        point.size = 2,                  # 设置点的大小
        signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary')   # 修改标题
        )
    }, error = function(e) {
      message(paste("Error in pathway", pathway, "for", names(object.list)[i], ": ", e$message))
      # 错误处理：可以在此处记录日志或简单地忽略错误
    })
  }

}
```

# Immune -> Oocyte
## Immune -> Oocyte 的旁分泌信号数量及强度 @rankNet
```{r,echo=TRUE}
# cellchat@idents
# T&S SMC EC Immune cell GC Oocyte

oo13 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("count"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 4,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling count from Immune to Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo14 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("weight"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 4,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling weight from Immune to Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo13+oo14

# 可知，Immune -> Oocyte 的旁分泌信号为：
# Young:   'CSF','MSTN','NT','CXCL','MIF'
#          'NPR2','BTLA','LIGHT','PARs','TNF','IL2','IGF','EGF','TGFb','CCL'
# Old:     'COMPLEMENT','CSF3','FLT3','NGF','FASLG','IL4','TRAIL','LT','GAS'

```

## Immune -> Oocyte 信号验证 @circle图
```{r,echo=TRUE,fig.width=9,fig.height=9,fig.align='center'}
# 在衰老过程中发生明显变化的通路
# 设置显示的通路
pathways.show <- c('CSF','MSTN','NT','CXCL','MIF',
                   'NPR2','BTLA','LIGHT','PARs','TNF','IL2','IGF','EGF','TGFb','CCL',
                   'COMPLEMENT','CSF3','FLT3','NGF','FASLG','IL4','TRAIL','LT','GAS')

                 
# 设置图像布局,每个通路有2张图（年轻和年老）
par(mfrow = c(2,2), xpd=TRUE)
# 遍历每个通路
for (pathway in pathways.show) {
  
  # 遍历年轻和年老组
  for (i in 1:length(object.list)) {
    # 使用 tryCatch 来捕获并忽略错误
    tryCatch({
      # 绘制网络图
      weight.max <- getMaxWeight(object.list, 
                               slot.name = c("netP"), 
                               attribute = pathway) # 控制不同数据集间的边权重
      
      netVisual_aggregate(
        object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
        signaling = pathway,             # 当前循环中的通路名称
        sources.use = 4,              # 指定源细胞群体的索引；默认为 NULL，表示使用所有源
        targets.use = 6,              # 指定目标细胞群体的索引；默认为 NULL，表示使用所有目标
        layout = "circle",               # 图的布局类型，这里选择圆形布局
        edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
        edge.width.max = 10,             # 设置可视化的最大边宽度，增大最大边宽度以调整箭头大小
        pt.title = 14,                   # 设置标题文本的字体大小
        title.space = 4,                 # 设置标题与图之间的空间
        vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
        vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
        sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
        alpha.image = 0.15,              # 设置单个点的透明度
        point.size = 2,                  # 设置点的大小
        signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary')   # 修改标题
        )
    }, error = function(e) {
      message(paste("Error in pathway", pathway, "for", names(object.list)[i], ": ", e$message))
      # 错误处理：可以在此处记录日志或简单地忽略错误
    })
  }

}
```

## Oocyte -> Immune 的旁分泌信号数量及强度 @rankNet
```{r,echo=TRUE}
oo15 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("count"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 4,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling count from Oocyte to Immune",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo16 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("weight"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 4,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling weight from Oocyte to Immune",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo15+oo16
# Oocyte -> Immune 的旁分泌信号为：
# Young:   'PLAU','CSF','ACTIVIN','NT',
#          'COMPLEMENT','NPR2','BTLA','LIGHT','PARs','IL2','IGF','EGF','CCL','MIF'
# Old:     'CSF3','FLT3','NGF','FASLG','CD40','IL4','TRAIL','LT','TGFb'

```

## Oocyte -> Immune 信号验证 @circle图
```{r,echo=TRUE,fig.width=9,fig.height=9,fig.align='center'}
# 在衰老过程中发生明显变化的通路
# 设置显示的通路
pathways.show <- c('PLAU','CSF','ACTIVIN','NT',
                   'COMPLEMENT','NPR2','BTLA','LIGHT','PARs','IL2','IGF','EGF','CCL','MIF',
                   'CSF3','FLT3','NGF','FASLG','CD40','IL4','TRAIL','LT','TGFb')

                 
# 设置图像布局,每个通路有2张图（年轻和年老）
par(mfrow = c(2,2), xpd=TRUE)
# 遍历每个通路
for (pathway in pathways.show) {
  
  # 遍历年轻和年老组
  for (i in 1:length(object.list)) {
    # 使用 tryCatch 来捕获并忽略错误
    tryCatch({
      # 绘制网络图
      weight.max <- getMaxWeight(object.list, 
                               slot.name = c("netP"), 
                               attribute = pathway) # 控制不同数据集间的边权重
      
      netVisual_aggregate(
        object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
        signaling = pathway,             # 当前循环中的通路名称
        sources.use = 6,              # 指定源细胞群体的索引；默认为 NULL，表示使用所有源
        targets.use = 4,              # 指定目标细胞群体的索引；默认为 NULL，表示使用所有目标
        layout = "circle",               # 图的布局类型，这里选择圆形布局
        edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
        edge.width.max = 10,             # 设置可视化的最大边宽度，增大最大边宽度以调整箭头大小
        pt.title = 14,                   # 设置标题文本的字体大小
        title.space = 4,                 # 设置标题与图之间的空间
        vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
        vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
        sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
        alpha.image = 0.15,              # 设置单个点的透明度
        point.size = 2,                  # 设置点的大小
        signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary')   # 修改标题
        )
    }, error = function(e) {
      message(paste("Error in pathway", pathway, "for", names(object.list)[i], ": ", e$message))
      # 错误处理：可以在此处记录日志或简单地忽略错误
    })
  }

}
```

## Oocyte-Immune 信号验证 @Hierarchy图
```{r,echo=TRUE,fig.width=12,fig.height=8,fig.align='center'}
# 定义集合
I2O <- c('CSF','MSTN','NT','CXCL','MIF',
         'NPR2','BTLA','LIGHT','PARs','TNF','IL2','IGF','EGF','TGFb','CCL',
         'COMPLEMENT','CSF3','FLT3','NGF','FASLG','IL4','TRAIL','LT','GAS')

O2I <- c('PLAU','CSF','ACTIVIN','NT',
         'COMPLEMENT','NPR2','BTLA','LIGHT','PARs','IL2','IGF','EGF','CCL','MIF',
         'CSF3','FLT3','NGF','FASLG','CD40','IL4','TRAIL','LT','TGFb')

# 取交集
common_elements <- intersect(I2O, O2I)

pathways.show <- common_elements  # FLT3

par(mfrow = c(1,2), xpd=TRUE)
for (pathway in pathways.show) {
  for (i in 1:length(object.list)) {
      weight.max <- getMaxWeight(object.list, 
                           slot.name = c("netP"), 
                           attribute = pathway) 
      
        netVisual_aggregate(
          object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
          signaling = pathway,             # 逐一传递单个通路名称
          sources.use = NULL,              # 指定源细胞群体的索引
          targets.use = NULL,              # 指定目标细胞群体的索引
          layout = "hierarchy",            # 图的布局类型，这里选择层次布局
          vertex.receiver = seq(3,1), 
          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
          pt.title = 15,                   # 设置标题文本的字体大小
          title.space = 4,                 # 设置标题与图之间的空间
          vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
          sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
          alpha.image = 0.15,              # 设置单个点的透明度
          point.size = 1.5,                # 设置点的大小
          edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
          edge.width.max = 10,             # 设置可视化的最大边宽度
          signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary') # 设置信号通路名称
        )
    }
}

```

# GC-Oocyte
## GC -> Oocyte 的旁分泌信号数量及强度 @rankNet
```{r,echo=TRUE}
oo17 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("count"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 5,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling count from GC to Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo18 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("weight"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 5,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 6,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling weight from GC to Oocyte",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo17+oo18
# GC -> Oocyte 的旁分泌信号为：
# Young:   'NPR2','GH','CSF','MSTN','NRG','PARs','ACTIVIN','NT','BMP','CALCR','EGF','VEGF','CCL','MIF',
#          'PSAP','MK',
# Old:     'FLT3','BAFF','NGF','LIGHT','GRN','TRAIL','FGF','IL2','PROS','GAS'

```

## GC -> Oocyte 信号验证 @circle图
```{r,echo=TRUE,fig.width=9,fig.height=9,fig.align='center'}
pathways.show <- c('NPR2','GH','CSF','MSTN','NRG','PARs','ACTIVIN','NT','BMP','CALCR','EGF','VEGF','CCL','MIF',
                   'PSAP','MK',
                   'FLT3','BAFF','NGF','LIGHT','GRN','TRAIL','FGF','IL2','PROS','GAS')

                 
# 设置图像布局,每个通路有2张图（年轻和年老）
par(mfrow = c(2,2), xpd=TRUE)
# 遍历每个通路
for (pathway in pathways.show) {
  
  # 遍历年轻和年老组
  for (i in 1:length(object.list)) {
    # 使用 tryCatch 来捕获并忽略错误
    tryCatch({
      # 绘制网络图
      weight.max <- getMaxWeight(object.list, 
                               slot.name = c("netP"), 
                               attribute = pathway) # 控制不同数据集间的边权重
      
      netVisual_aggregate(
        object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
        signaling = pathway,             # 当前循环中的通路名称
        sources.use = 5,              # 指定源细胞群体的索引；默认为 NULL，表示使用所有源
        targets.use = 6,              # 指定目标细胞群体的索引；默认为 NULL，表示使用所有目标
        layout = "circle",               # 图的布局类型，这里选择圆形布局
        edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
        edge.width.max = 10,             # 设置可视化的最大边宽度，增大最大边宽度以调整箭头大小
        pt.title = 14,                   # 设置标题文本的字体大小
        title.space = 4,                 # 设置标题与图之间的空间
        vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
        vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
        sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
        alpha.image = 0.15,              # 设置单个点的透明度
        point.size = 2,                  # 设置点的大小
        signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary')   # 修改标题
        )
    }, error = function(e) {
      message(paste("Error in pathway", pathway, "for", names(object.list)[i], ": ", e$message))
      # 错误处理：可以在此处记录日志或简单地忽略错误
    })
  }
}
```

## Oocyte -> GC 的旁分泌信号数量及强度 @rankNet
```{r,echo=TRUE}
oo19 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("count"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 5,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling count from Oocyte to GC",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo20 <- rankNet(
  cellchat,                            # CellChat 对象，包含细胞间的通信信息
  slot.name = "netP",                  # 对象槽名称，用于计算信号网络的中心性度量
  measure = c("weight"),                # 度量方式，"count" 表示比较互动数量
  mode = c("comparison"),              # 模式，"comparison" 表示对两个数据集进行比较
  comparison = c(1, 2),                # 一个数值向量，给出要比较的两个数据集
  stacked = FALSE,                     # 是否绘制堆叠条形图，设置为 FALSE
  thresh = 0.05,                       # 确定显著互动的p值阈值
  sources.use = 6,                  # 源细胞群体的索引或名称，设置为 NULL 表示使用所有细胞群体
  targets.use = 5,                     # 目标细胞群体的索引或名称，这里 6 表示卵母细胞（Oocyte）
  title = "Signaling weight from Oocyte to GC",  # 图的主标题
  bar.w = 1,                           # 条形图的宽度
  font.size = 8                        # 字体大小
)

oo19+oo20
# Oocyte -> GC 的旁分泌信号为：
# Young:   'NPR2','IL10','CSF','MSTN','IFN-II','PARs','ACTIVIN','NT','BMP','IGF','IGFBP','GAS','VISFATIN','CCL',
#             'EGF','TGFb','CypA',
# Old:     'FLT3','BAFF','NGF','FASLG','TRAIL','FGF','IL2'

```

## Oocyte -> GC 信号验证 @circle图
```{r,echo=TRUE,fig.width=9,fig.height=9,fig.align='center'}
pathways.show <- c('NPR2','IL10','CSF','MSTN','IFN-II','PARs','ACTIVIN','NT','BMP','IGF','IGFBP','GAS','VISFATIN','CCL',
                   'EGF','TGFb','CypA',
                   'FLT3','BAFF','NGF','FASLG','TRAIL','FGF','IL2')

                 
# 设置图像布局,每个通路有2张图（年轻和年老）
par(mfrow = c(2,2), xpd=TRUE)
# 遍历每个通路
for (pathway in pathways.show) {
  
  # 遍历年轻和年老组
  for (i in 1:length(object.list)) {
    # 使用 tryCatch 来捕获并忽略错误
    tryCatch({
      # 绘制网络图
      weight.max <- getMaxWeight(object.list, 
                               slot.name = c("netP"), 
                               attribute = pathway) # 控制不同数据集间的边权重
      
      netVisual_aggregate(
        object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
        signaling = pathway,             # 当前循环中的通路名称
        sources.use = 6,              # 指定源细胞群体的索引；默认为 NULL，表示使用所有源
        targets.use = 5,              # 指定目标细胞群体的索引；默认为 NULL，表示使用所有目标
        layout = "circle",               # 图的布局类型，这里选择圆形布局
        edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
        edge.width.max = 10,             # 设置可视化的最大边宽度，增大最大边宽度以调整箭头大小
        pt.title = 14,                   # 设置标题文本的字体大小
        title.space = 4,                 # 设置标题与图之间的空间
        vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
        vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
        sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
        alpha.image = 0.15,              # 设置单个点的透明度
        point.size = 2,                  # 设置点的大小
        signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary')   # 修改标题
        )
    }, error = function(e) {
      message(paste("Error in pathway", pathway, "for", names(object.list)[i], ": ", e$message))
      # 错误处理：可以在此处记录日志或简单地忽略错误
    })
  }
}
```

## Oocyte-GC 信号验证 @Hierarchy图
```{r,echo=TRUE,fig.width=12,fig.height=8,fig.align='center'}
# 定义集合
G2O <- c('NPR2','GH','CSF','MSTN','NRG','PARs','ACTIVIN','NT','BMP','CALCR','EGF','VEGF','CCL','MIF',
                   'PSAP','MK',
                   'FLT3','BAFF','NGF','LIGHT','GRN','TRAIL','FGF','IL2','PROS','GAS')

O2G <- c('NPR2','IL10','CSF','MSTN','IFN-II','PARs','ACTIVIN','NT','BMP','IGF','IGFBP','GAS','VISFATIN','CCL',
                   'EGF','TGFb','CypA',
                   'FLT3','BAFF','NGF','FASLG','TRAIL','FGF','IL2')

# 取交集
common_elements <- intersect(G2O, O2G)

pathways.show <- common_elements  # 'EGF','FLT3','BAFF','NGF','FGF'

par(mfrow = c(1,2), xpd=TRUE)
for (pathway in pathways.show) {
  for (i in 1:length(object.list)) {
      weight.max <- getMaxWeight(object.list, 
                           slot.name = c("netP"), 
                           attribute = pathway) 
      
        netVisual_aggregate(
          object.list[[i]],                # CellChat 对象，来自对象列表的第 i 个元素
          signaling = pathway,             # 逐一传递单个通路名称
          sources.use = NULL,              # 指定源细胞群体的索引
          targets.use = NULL,              # 指定目标细胞群体的索引
          layout = "hierarchy",            # 图的布局类型，这里选择层次布局
          vertex.receiver = seq(3,1), 
          vertex.weight = cell_proportions, # 节点的权重：这里设置为细胞比例
          pt.title = 15,                   # 设置标题文本的字体大小
          title.space = 4,                 # 设置标题与图之间的空间
          vertex.label.cex = 0.8,          # 设置网络中顶点标签的大小
          sample.use = NULL,               # 用于可视化的样本；默认为 NULL，表示使用所有样本
          alpha.image = 0.15,              # 设置单个点的透明度
          point.size = 1.5,                # 设置点的大小
          edge.weight.max = weight.max[1], # 设置边的最大权重，使用 weight.max 向量的第一个值
          edge.width.max = 10,             # 设置可视化的最大边宽度
          signaling.name = paste(pathway, 'in', names(object.list)[i], 'ovary') # 设置信号通路名称
        )
    }
}

```






